<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ—è­·èª²ç¨‹æŸ¥è©¢ç³»çµ± - ç™»å…¥</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/login.css') }}">
</head>
<body>
    <!-- ========================================
         ä¸»å®¹å™¨
         ======================================== -->
    <div class="container">
        
        <!-- ========================================
             å·¦å´ï¼šå­¸æ ¡è³‡è¨Šå€
             ======================================== -->
        <div class="left-section">
            <div class="school-info">
                <!-- Logoå€ -->
                <div class="logo-container">
                    <svg class="logo" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <!-- åŒ—è­·Logoï¼šç¶ åå­— + é‡‘è‰²å¤–æ¡† -->
                        <circle cx="50" cy="50" r="45" fill="#2D5A3D" stroke="#FFD700" stroke-width="3"/>
                        <rect x="42" y="20" width="16" height="60" fill="white" rx="2"/>
                        <rect x="20" y="42" width="60" height="16" fill="white" rx="2"/>
                        <!-- æœˆæ¡‚è‘‰è£é£¾ -->
                        <path d="M15,50 Q15,30 25,25 L20,50 Z" fill="#FFD700"/>
                        <path d="M85,50 Q85,30 75,25 L80,50 Z" fill="#FFD700"/>
                    </svg>
                    <h1>åœ‹ç«‹è‡ºåŒ—è­·ç†å¥åº·å¤§å­¸</h1>
                    <p class="english">National Taipei University of Nursing and Health Sciences</p>
                </div>
                
                <!-- é€£çµå€ -->
                <div class="links">
                    <a href="/guest" class="admin-link guest-link">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="10" cy="7" r="4"/>
                            <path d="M3 19c0-3.3 2.7-6 6-6h2c3.3 0 6 2.7 6 6"/>
                        </svg>
                        è¨ªå®¢æ¨¡å¼
                    </a>
                    <a href="https://www.ntunhs.edu.tw" target="_blank" class="back-link">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M15 18l-6-6 6-6"/>
                        </svg>
                        è¿”å›é¦–é 
                    </a>
                </div>
            </div>
        </div>
        
        <!-- ========================================
             å³å´ï¼šç™»å…¥è¡¨å–®å€
             ======================================== -->
        <div class="right-section">
            <div class="login-box">
                <h2>Student Login</h2>
                
                <!-- ç™»å…¥è¡¨å–® -->
                <form id="loginForm" onsubmit="handleLogin(event)">
                    <!-- å¸³è™Ÿè¼¸å…¥ -->
                    <div class="input-group">
                        <input 
                            type="text" 
                            id="username" 
                            placeholder="Username"
                            required
                            autocomplete="username"
                        >
                    </div>
                    
                    <!-- å¯†ç¢¼è¼¸å…¥ -->
                    <div class="input-group">
                        <input 
                            type="password" 
                            id="password" 
                            placeholder="Password"
                            required
                            autocomplete="current-password"
                        >
                        <!-- é¡¯ç¤º/éš±è—å¯†ç¢¼æŒ‰éˆ• -->
                        <button type="button" class="toggle-password" onclick="togglePassword()" tabindex="-1">
                            <svg id="eyeIcon" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                <circle cx="12" cy="12" r="3"/>
                                <line id="eyeSlash" x1="1" y1="1" x2="23" y2="23" stroke-width="2" style="display: none;"/>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- å¿˜è¨˜å¯†ç¢¼ -->
                    <a href="#" class="forgot-password" onclick="showForgotPassword(); return false;">å¿˜è¨˜å¯†ç¢¼?</a>
                    
                    <!-- ç™»å…¥æŒ‰éˆ• -->
                    <button type="submit" class="login-btn">ç™»å…¥</button>
                    
                    <!-- è¨Šæ¯æç¤ºå€ -->
                    <div id="loginMessage" class="message"></div>
                </form>
                
                <!-- æ¸¬è©¦å¸³è™Ÿæç¤º -->
                <div class="test-hint">
                    <p>
                        ğŸ’¡ æ¸¬è©¦å¸³è™Ÿ<br>
                        å­¸ç”Ÿï¼šstudent1 / pass123<br>
                        ç®¡ç†å“¡ï¼šadmin / admin123
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ========================================
         Modal: å¿˜è¨˜å¯†ç¢¼ - é©—è­‰å¸³è™Ÿ (Figmaè¨­è¨ˆ)
         ======================================== -->
    <div id="forgotPasswordModal" class="modal">
        <div class="modal-content modal-figma">
            <div class="modal-header-figma">
                <div class="modal-title-with-icon">
                    <span class="modal-icon">ğŸ”’</span>
                    <h3>å¿˜è¨˜å¯†ç¢¼</h3>
                </div>
                <button class="btn-back-figma" onclick="closeForgotPassword()">è¿”å›</button>
            </div>
            <div class="modal-body-figma">
                <div class="modal-card">
                    <h4 class="card-title">é©—è­‰å¸³è™Ÿ</h4>
                    <p class="card-hint">è«‹è¼¸å…¥æ‚¨çš„å­¸è™Ÿ/ID å’Œæ‰‹æ©Ÿè™Ÿç¢¼é€²è¡Œé©—è­‰</p>
                    
                    <div class="form-group-figma">
                        <label>å­¸è™Ÿ/IDï¼š</label>
                        <input type="text" id="forgotStudentId" placeholder="è«‹è¼¸å…¥å­¸è™Ÿ/ID">
                    </div>
                    
                    <div class="form-group-figma">
                        <label>æ‰‹æ©Ÿè™Ÿç¢¼ï¼š</label>
                        <input type="tel" id="forgotPhone" placeholder="è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼">
                    </div>
                    
                    <div id="forgotMessage" class="message"></div>
                    
                    <button type="button" class="btn-confirm-figma" onclick="verifyForgotPassword()">ç¢ºå®š</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ========================================
         Modal: å¿˜è¨˜å¯†ç¢¼ - é‡è¨­å¯†ç¢¼ (Figmaè¨­è¨ˆ)
         ======================================== -->
    <div id="resetPasswordModal" class="modal">
        <div class="modal-content modal-figma">
            <div class="modal-header-figma">
                <div class="modal-title-with-icon">
                    <span class="modal-icon">ğŸ”’</span>
                    <h3>æ›´æ–°å¯†ç¢¼</h3>
                </div>
                <button class="btn-back-figma" onclick="closeResetPassword()">è¿”å›</button>
            </div>
            <div class="modal-body-figma">
                <div class="modal-card">
                    <input type="hidden" id="resetUserId">
                    
                    <div class="form-group-figma">
                        <label>æ–°å¯†ç¢¼ï¼š</label>
                        <input type="password" id="resetNewPassword" placeholder="è«‹è¼¸å…¥æ–°å¯†ç¢¼">
                    </div>
                    
                    <div class="form-group-figma">
                        <label>å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼ï¼š</label>
                        <input type="password" id="resetConfirmPassword" placeholder="è«‹å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼">
                    </div>
                    
                    <div id="resetMessage" class="message"></div>
                    
                    <button type="button" class="btn-confirm-figma" onclick="submitResetPassword()">ç¢ºå®š</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ========================================
         JavaScriptï¼šç™»å…¥åŠŸèƒ½
         ======================================== -->
    <script>
        // åˆ‡æ›å¯†ç¢¼é¡¯ç¤º/éš±è—
        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const eyeSlash = document.getElementById('eyeSlash');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                eyeSlash.style.display = 'block';
            } else {
                passwordInput.type = 'password';
                eyeSlash.style.display = 'none';
            }
        }
        
        // è™•ç†ç™»å…¥
        async function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const messageElement = document.getElementById('loginMessage');
            const loginBtn = document.querySelector('.login-btn');
            
            // é©—è­‰è¼¸å…¥
            if (!username || !password) {
                messageElement.textContent = 'è«‹è¼¸å…¥å¸³è™Ÿå’Œå¯†ç¢¼';
                messageElement.className = 'message error';
                return;
            }
            
            // é¡¯ç¤ºè¼‰å…¥ä¸­
            loginBtn.textContent = 'ç™»å…¥ä¸­...';
            loginBtn.disabled = true;
            messageElement.textContent = '';
            
            try {
                // ç™¼é€ç™»å…¥è«‹æ±‚
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username, password})
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // ç™»å…¥æˆåŠŸ
                    messageElement.textContent = 'âœ“ ç™»å…¥æˆåŠŸï¼è·³è½‰ä¸­...';
                    messageElement.className = 'message success';
                    
                    // å„²å­˜ä½¿ç”¨è€…è³‡è¨Šåˆ°localStorage
                    localStorage.setItem('currentUser', JSON.stringify(result));
                    
                    // æ ¹æ“šè§’è‰²è·³è½‰
                    setTimeout(() => {
                        if (result.role === 'student') {
                            window.location.href = '/student';
                        } else if (result.role === 'admin') {
                            window.location.href = '/admin';
                        }
                    }, 800);
                } else {
                    // ç™»å…¥å¤±æ•—
                    messageElement.textContent = 'âœ— ' + (result.message || 'å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤');
                    messageElement.className = 'message error';
                    loginBtn.textContent = 'ç™»å…¥';
                    loginBtn.disabled = false;
                }
            } catch (error) {
                // ç¶²è·¯éŒ¯èª¤ - æ”¹å–„éŒ¯èª¤è¨Šæ¯
                messageElement.textContent = 'âœ— ç™»å…¥å¤±æ•—ï¼š' + (error.message || 'è«‹æª¢æŸ¥ç¶²è·¯é€£ç·š');
                messageElement.className = 'message error';
                loginBtn.textContent = 'ç™»å…¥';
                loginBtn.disabled = false;
                console.error('ç™»å…¥éŒ¯èª¤:', error);
            }
        }
        
        // Enteréµå¿«é€Ÿç™»å…¥
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const form = document.getElementById('loginForm');
                if (form) form.dispatchEvent(new Event('submit'));
            }
        });
        
        // ========================================
        // å¿˜è¨˜å¯†ç¢¼åŠŸèƒ½
        // ========================================
        function showForgotPassword() {
            document.getElementById('forgotPasswordModal').style.display = 'flex';
            document.getElementById('forgotStudentId').value = '';
            document.getElementById('forgotPhone').value = '';
            document.getElementById('forgotMessage').textContent = '';
        }
        
        function closeForgotPassword() {
            document.getElementById('forgotPasswordModal').style.display = 'none';
        }
        
        async function verifyForgotPassword() {
            const studentId = document.getElementById('forgotStudentId').value.trim();
            const phone = document.getElementById('forgotPhone').value.trim();
            const messageEl = document.getElementById('forgotMessage');
            
            if (!studentId || !phone) {
                messageEl.textContent = 'è«‹è¼¸å…¥å­¸è™Ÿå’Œæ‰‹æ©Ÿè™Ÿç¢¼';
                messageEl.className = 'message error';
                return;
            }
            
            try {
                const response = await fetch('/api/forgot-password/verify', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ student_id: studentId, phone: phone })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeForgotPassword();
                    // é¡¯ç¤ºé‡è¨­å¯†ç¢¼è¦–çª—
                    document.getElementById('resetUserId').value = result.user_id;
                    document.getElementById('resetNewPassword').value = '';
                    document.getElementById('resetConfirmPassword').value = '';
                    document.getElementById('resetMessage').textContent = '';
                    document.getElementById('resetPasswordModal').style.display = 'flex';
                } else {
                    messageEl.textContent = result.message || 'é©—è­‰å¤±æ•—';
                    messageEl.className = 'message error';
                }
            } catch (error) {
                console.error('é©—è­‰éŒ¯èª¤:', error);
                messageEl.textContent = 'ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦';
                messageEl.className = 'message error';
            }
        }
        
        function closeResetPassword() {
            document.getElementById('resetPasswordModal').style.display = 'none';
        }
        
        async function submitResetPassword() {
            const userId = document.getElementById('resetUserId').value;
            const newPassword = document.getElementById('resetNewPassword').value;
            const confirmPassword = document.getElementById('resetConfirmPassword').value;
            const messageEl = document.getElementById('resetMessage');
            
            if (!newPassword || !confirmPassword) {
                messageEl.textContent = 'è«‹è¼¸å…¥æ–°å¯†ç¢¼';
                messageEl.className = 'message error';
                return;
            }
            
            if (newPassword !== confirmPassword) {
                messageEl.textContent = 'å…©æ¬¡å¯†ç¢¼è¼¸å…¥ä¸ä¸€è‡´';
                messageEl.className = 'message error';
                return;
            }
            
            try {
                const response = await fetch('/api/forgot-password/reset', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: userId,
                        new_password: newPassword,
                        confirm_password: confirmPassword
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    messageEl.textContent = 'å¯†ç¢¼é‡è¨­æˆåŠŸï¼';
                    messageEl.className = 'message success';
                    setTimeout(() => {
                        closeResetPassword();
                        alert('å¯†ç¢¼å·²é‡è¨­ï¼Œè«‹ä½¿ç”¨æ–°å¯†ç¢¼ç™»å…¥');
                    }, 1000);
                } else {
                    messageEl.textContent = result.message || 'é‡è¨­å¤±æ•—';
                    messageEl.className = 'message error';
                }
            } catch (error) {
                console.error('é‡è¨­å¯†ç¢¼éŒ¯èª¤:', error);
                messageEl.textContent = 'ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦';
                messageEl.className = 'message error';
            }
        }
    </script>
</body>
</html>
